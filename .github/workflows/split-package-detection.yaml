name: Split Package Detection

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # Optional: Run manually from the Actions tab
  workflow_dispatch:

jobs:
  check-split-packages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build with Maven
        run: mvn package -Dspotless.check.skip=true -Dmaven.javadoc.skip=true -DskipTests -DskipITs

      - name: Create split package detection script
        run: |
          cat > check-split-packages.sh << 'EOF'
          #!/bin/bash
          # Usage: ./check-split-packages.sh /path/to/your/root/dir
          ROOT_DIR="${1:-.}"  # default to current dir if no argument passed
          
          # Use process substitution instead of pipes to avoid subshell issues
          declare -A package_map
          declare -A seen
          declare -A last_conflict_jar  # Track the last conflicting jar for each package
          
          echo "ğŸ” Scanning all JARs under: $ROOT_DIR (excluding test JARs)"
          
          # Get all JAR files first, excluding test JARs
          jar_files=()
          while IFS= read -r jar; do
            # Skip JAR files ending with "-tests.jar"
            if [[ "$jar" != *"-tests.jar" ]]; then
              jar_files+=("$jar")
            fi
          done < <(find "$ROOT_DIR" -type f -name "*.jar")
          
          echo "Found ${#jar_files[@]} non-test JAR files to analyze"
          
          # Process each JAR file
          for jar in "${jar_files[@]}"; do
            jarname=$(realpath "$jar")
            jarbasename=$(basename "$jarname")  # Get just the filename without path
            tmpdir=$(mktemp -d)
            unzip -qq "$jar" -d "$tmpdir"
            
            # Get all class files
            class_files=()
            while IFS= read -r classfile; do
              class_files+=("$classfile")
            done < <(find "$tmpdir" -type f -name "*.class")
            
            # Process each class file
            for classfile in "${class_files[@]}"; do
              pkg=$(dirname "${classfile#$tmpdir/}" | tr '/' '.')
              [[ "$pkg" == "." ]] && continue  # skip default package
            
              if [ -n "${package_map[$pkg]}" ]; then
                if [ "${package_map[$pkg]}" != "$jarbasename" ]; then
                  if [[ -z "${seen[$pkg]}" ]]; then
                    # First time seeing this conflict
                    echo "ğŸš¨ Split package detected: $pkg"
                    echo "    â†³ in: ${package_map[$pkg]}"
                    echo "    â†³ and: $jarbasename"
                    seen[$pkg]=1
                    last_conflict_jar[$pkg]="$jarbasename"
                  elif [[ "${last_conflict_jar[$pkg]}" != "$jarbasename" ]]; then
                    # New jar with same conflict
                    echo "    â†³ also in: $jarbasename"
                    last_conflict_jar[$pkg]="$jarbasename"
                  fi
                  # If it's the same jar as last time, we don't print anything
                fi
              else
                package_map[$pkg]=$jarbasename;
              fi
            done
              
            rm -rf "$tmpdir"
          done
            
          if [[ ${#seen[@]} -eq 0 ]]; then
            echo "âœ… No split packages found!"
          else
            echo "âŒ Split packages detected â€” please fix before modularizing."
            exit 1
          fi
          EOF
          chmod +x check-split-packages.sh

      - name: Run split package detection
        run: |
          ./check-split-packages.sh 

      - name: Upload results as artifact if failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: split-package-report
          path: |
            check-split-packages.sh
            # You could save the output to a file and include that too
